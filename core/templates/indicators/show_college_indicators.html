{% extends 'base_new.html' %}{% load static %}
{% block title %}Fudul | {{ college.name }} indicators{% endblock %}

{% block header_title %}
<h1>{{ college.name }} indicators</h1>
{% endblock %}

{% block breadcrumb %}
      <li class="breadcrumb-item"><a href="{% url 'index' %}">Home page</a></li>
      <li class="breadcrumb-item"><a href="{% url 'show_indicator_index' %}">Indicators</a></li>
			<li class="breadcrumb-item active">{{ college.name }}</li>
{% endblock %}

{% block head %}
<script src="https://cdn.plot.ly/plotly-1.31.2.min.js" integrity="sha384-pEbvKAAHroDnU/rb2+IiUrslRtrsAGTaQNZjaFWCY3d/h5FlaWxqMkhh8MX4m0dQ" crossorigin="anonymous"></script>
{% endblock %}


{% block content %}
<div class="card">
	<div class="card-body">
		<div class="card-block">
      <div id="college-user-plot" style="width:100%; height:600px;"></div>
      <div id="college-answer-plot" style="width:100%; height:600px;"></div>
		</div><!--card-block-->
	</div><!--card-body-->
</div><!--card-->
{% endblock %}
{% block customscript %}
{% include 'partials/import_datatables.html' %}
  <script>

batch_names = { {% for batch in college.batch_set.all %}{{ batch.pk }}: '{{ batch.name }}',{% endfor %}
}

  Plotly.d3.csv("{% static csv_filename %}", function(err, rows){
      function unpack(rows, key, is_int) {
        if (is_int){
          return rows.map(function(row) { return parseInt(row[key]); });
        } else {
          return rows.map(function(row) { return row[key]; });
        }

      }

      function stackedArea(data) {
      	for(var i=1; i<data.length; i++) {
      		for(var j=0; j<(Math.min(data[i]['y'].length, data[i-1]['y'].length)); j++) {
        			data[i]['y'][j] += data[i-1]['y'][j];
      		}
      	}
      	return data;
      }

      user_data = [];
      answer_data = [];

      for (batch_pk in batch_names){
        var trace = {
          fill: 'tonextx',
          name: batch_names[batch_pk],
          x: unpack(rows, 'date'),
          y: unpack(rows, 'user_count_' + batch_pk, true),
          hoverinfo: 'text+name+x',
          hovertext: unpack(rows, 'user_count_' + batch_pk, true),
        }
        user_data.push(trace);
      }

      for (batch_pk in batch_names){
        var trace = {
          fill: 'tonextx',
          name: batch_names[batch_pk],
          x: unpack(rows, 'date'),
          y: unpack(rows, 'answer_avg_' + batch_pk, true),
          hoverinfo: 'text+name+x',
          hovertext: unpack(rows, 'answer_avg_' + batch_pk, true),
        }
        answer_data.push(trace);
      }

      Plotly.newPlot('college-user-plot', stackedArea(user_data), {title: "{{ college.name}} user plot"});
      Plotly.newPlot('college-answer-plot', stackedArea(answer_data), {title: "{{ college.name}} answer plot"});
  })
    </script>

{% endblock %}
