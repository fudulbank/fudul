{% extends 'base_new.html' %}{% load static %}
{% block title %}Fudul | {{ college.name }} indicators{% endblock %}

{% block header_title %}
<h1>{{ college.name }} indicators</h1>
{% endblock %}

{% block breadcrumb %}
      <li class="breadcrumb-item"><a href="{% url 'index' %}">Home page</a></li>
      <li class="breadcrumb-item"><a href="{% url 'show_indicator_index' %}">Indicators</a></li>
			<li class="breadcrumb-item active">{{ college.name }}</li>
{% endblock %}

{% block head %}
<script src="https://cdn.plot.ly/plotly-1.31.2.min.js" integrity="sha384-pEbvKAAHroDnU/rb2+IiUrslRtrsAGTaQNZjaFWCY3d/h5FlaWxqMkhh8MX4m0dQ" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.3/moment.min.js" integrity="sha384-8xuC0/BWqiPX72DT7LJqj+QiH5eYVT5KsUOewB/DmXi7KPPEdt4Td3xu3lg+slER" crossorigin="anonymous"></script>
{% endblock %}


{% block content %}
<div class="card">
	<div class="card-body">
		<div class="card-block">
      <p>These two graphs track <strong>active users</strong> (defined as: users who created at least one new session) and <strong>average answers</strong> (defined as: answers submitted with a choice, i.e. not skipped, divided by number of active users).  This only includes users in the {{ college.name }} at {{ college.institution.name }} and is broken down per batch.</p>
      <div id="college-user-plot" style="width:100%; height:600px;"></div>
      <div id="college-answer-plot" style="width:100%; height:600px;"></div>
      <div id="college-contributor-plot" style="width:100%; height:600px;"></div>
      <div id="college-contribution-plot" style="width:100%; height:600px;"></div>
		</div><!--card-block-->
	</div><!--card-body-->
</div><!--card-->
{% endblock %}
{% block customscript %}
  <script>

batch_names = { {% for batch in college.batch_set.all %}{{ batch.pk }}: '{{ batch.name }}',{% endfor %}
}

  Plotly.d3.csv("{% url 'get_privileged_file' csv_filename %}", function(err, rows){

{% include 'indicators/partials/shared_functions.js' %}

      function get_contribution_hover(batch_pk){
        explanation_field = 'explanation_count_' + batch_pk;
        revision_field = 'revision_count_' + batch_pk;
        return rows.map(function(row) {
          end_date = moment(row['date'])
          start_date = moment(row['date']).subtract(30, 'days')

          // Calculate change
          explanation_percentage = get_change_percentage(explanation_field, row)
          revision_percentage = get_change_percentage(revision_field, row)

          end_date_str = end_date.format('DD MMM')
          start_date_str = start_date.format('DD MMM')
          return 'Revisions added: ' + row[revision_field] + ' (' + revision_percentage + '%)<br>' + 'Explanations added: ' + row[explanation_field] + ' (' + explanation_percentage + '%)<br>' + start_date_str + 'â€’' + end_date_str
        });
      }

      function stackedArea(data) {
      	for(var i=1; i<data.length; i++) {
      		for(var j=0; j<(Math.min(data[i]['y'].length, data[i-1]['y'].length)); j++) {
        			data[i]['y'][j] += data[i-1]['y'][j];
      		}
      	}
      	return data;
      }

      user_data = [];
      answer_data = [];
      contributor_data = [];
      contribution_data = [];

      dates = unpack(rows, 'date');

      for (batch_pk in batch_names){
        var trace = {
          fill: 'tonextx',
          name: batch_names[batch_pk],
          x: dates,
          y: unpack(rows, 'user_count_' + batch_pk, true),
          hoverinfo: 'text+name',
          hovertext: get_hover('user_count', batch_pk),
        }
        user_data.push(trace);
      }

      for (batch_pk in batch_names){
        var trace = {
          fill: 'tonextx',
          name: batch_names[batch_pk],
          x: dates,
          y: unpack('answer_avg_' + batch_pk, true),
          hoverinfo: 'text+name',
          hovertext: get_hover('answer_avg', batch_pk),
        }
        answer_data.push(trace);
      }

      for (batch_pk in batch_names){
        var trace = {
          fill: 'tonextx',
          name: batch_names[batch_pk],
          x: dates,
          y: unpack('contributor_count_' + batch_pk, true),
          hoverinfo: 'text+name',
          hovertext: get_hover('contributor_count', batch_pk),
        }
        contributor_data.push(trace);
      }

      for (batch_pk in batch_names){
        var trace = {
          fill: 'tonextx',
          name: batch_names[batch_pk],
          x: dates,
          y: get_contribution_data(batch_pk),
          hoverinfo: 'text+name',
          hovertext: get_contribution_hover(batch_pk),
        }
        contribution_data.push(trace);
      }

      Plotly.newPlot('college-user-plot', stackedArea(user_data), {title: "{{ college.name}} user plot"});
      Plotly.newPlot('college-answer-plot', stackedArea(answer_data), {title: "{{ college.name}} answer plot"});

      Plotly.newPlot('college-contributor-plot', stackedArea(contributor_data), {title: "{{ college.name}} contributor plot"});
      Plotly.newPlot('college-contribution-plot', stackedArea(contribution_data), {title: "{{ college.name}} revision plot"});
  })
    </script>

{% endblock %}
