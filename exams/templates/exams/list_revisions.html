{% extends 'base_new.html' %}{% load staticfiles account_utils %}
{% block title %}Fudul | Question #{{ question.pk }} revisions{% endblock %}
{% block head %}
<link rel="stylesheet" type="text/css" href="{% static 'stack/vendors/css/tables/datatable/dataTables.bootstrap4.min.css' %}">

<style>
.panel-body p{
    margin-left: 5%;
}
#revision-list  th, td{
    text-align: left;
}

#revision-list tbody{
    cursor:pointer;
}

</style>
{% endblock %}

{% block header_title %}
<h1>Question #{{ question.pk }} revisions</h1>
{% with is_list_active=True %}
{% include 'exams/partials/exam_editor_buttons.html' %}
{% endwith %}
{% endblock %}

{% block breadcrumb %}
      <li class="breadcrumb-item"><a href="{% url 'index' %}">Home page</a></li>
      <li class="breadcrumb-item"><a href="{% url 'exams:list_meta_categories' %}">Exams</a></li>
			{% for parent_category in exam.category.get_parent_categories %}
			<li class="breadcrumb-item"><a href="{% url 'exams:show_category' parent_category.get_slugs %}">{{ parent_category.name }}</a></li>
			{% endfor %}
			<li class="breadcrumb-item"><a href="{% url 'exams:show_category' exam.category.get_slugs %}">{{ exam.category.name }}</a></li>
      <li class="breadcrumb-item"><a href="{% url 'exams:create_session' exam.category.get_slugs exam.pk %}">{{ exam.name }}</a></li>
      <li class="breadcrumb-item"><a href="{% url 'exams:list_questions' exam.category.get_slugs exam.pk %}">List</a></li>
      <li class="breadcrumb-item active">Question #{{ question.pk }} revisions</li>
{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <div class="heading-elements">
      <a href="{% url 'exams:submit_revision' question.subjects.first.exam.category.get_slugs question.subjects.first.exam.pk question.pk %}" class="btn btn-warning btn-rounded btn-xs"><i class="icon-pencil position-left"></i> Edit</a>
    </div>
	</div>
  <div class="card-body">
    <div class="card-block">
  <table style="width: auto; margin-right: auto; margin-left: auto;" class="table table-condensed">
    <tr>
      <th>Subjects</th>
      <td>
        <ul>
        {% for subject in question.subjects.all %}<li>{{ subject.name }}</li>
        </ul>
        {% endfor %}
      </td>
        <th>Sources</th>
        <td>
          <ul>
          {% for source in question.sources.all %}<li>{{ source.name }}</li>
          </ul>
          {% endfor %}
        </td>
      </tr>
      <tr>
        <th>Exam types</th>
        <td>
          <ul>
          {% for exam_type in question.exam_types.all %}<li>{{ exam_type.name }}</li>
          </ul>
          {% endfor %}
        </td>
        <th>Statuses</th>
        <td>
          <ul>
          {% for status in question.statuses.all %}<li>{{ status.name }}</li>
          </ul>
          {% endfor %}
        </td>
      </tr>
  </table>
  <table id="revision-list" class="table table-striped table-bordered datatable dt-responsive">
        <thead>
            <tr>
                <th>Submitter</th>
                <th>Date of Submission</th>
                <th class="not-mobile">Status</th>
                <th>Is approved?</th>
								<th class="always">Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for revision in question.revision_set.undeleted.order_by_submission %}
            <tr data-url="{% url 'exams:show_question' revision.question.pk revision.pk %}" data-pk="{{ revision.pk }}">
            <td>{% get_user_representation revision.submitter %}</td>
            <td data-order="{{ revision.submission_date|date:'U' }}">{{ revision.submission_date }}</td>
            <td>
                <ul>{% for status in revision.statuses.all %}<li>{{ status.name }}</li>{% endfor %}</ul>
            </td>
            <td class="status {% if revision.is_approved %}text-success{% else %}text-danger{% endif %}">{% if revision.is_approved %}Yes {% if revision.approved_by %}<br>By {% get_user_representation revision.approved_by %} {% endif %}{% else %}No{% endif %}</td>
						<td>
                <div class="dropdown">
                  <button type="button" class="btn btn-sm btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="ft-settings"></i> Actions</button>
                  <div class="dropdown-menu">
                    <a{% if not revision.is_approved %} style="display: none;"{% endif %} data-pk="{{ revision.pk }}" data-url="{% url 'exams:mark_revision_pending' revision.pk %}" class="dropdown-item pend-revision"><i class="ft-filter"></i> Mark as pending</a>
                    <a{% if revision.is_approved %} style="display: none;"{% endif %} data-pk="{{ revision.pk }}" data-url="{% url 'exams:mark_revision_approved' revision.pk %}" class="dropdown-item approve-revision"><i class="ft-check-square"></i> Approve</a>
                    <a data-pk="{{ revision.pk }}" data-url="{% url 'exams:delete_revision' revision.pk %}"  class="dropdown-item confirm-delete-revision"><i class="ft-trash-2"></i> Delete</a>
                  </div>
                </div>
						</td>
            </tr>
        {% endfor %}
        </tbody>
      </table>
    </div><!--card-block-->
  </div><!--card-card-->
</div><!--card-->
{% endblock %}
{% block customscript %}
<script src="{% static 'stack/vendors/js/tables/jquery.dataTables.min.js' %}" type="text/javascript"></script>
<script src="{% static 'stack/vendors/js/tables/datatable/dataTables.bootstrap4.min.js' %}" type="text/javascript"></script>
<script src="{% static 'stack/vendors/js/tables/datatable/dataTables.responsive.min.js' %}" type="text/javascript"></script>

<script src="{% static 'js/toastr.js' %}"></script>

<script type="text/javascript">
    $(function () {
        $revision_table = $("#revision-list").DataTable({
	            order: [[ 1, "desc" ]]
	      });
        // initialize project edit modal
        $('#show-revision-modal').modal({
          keyboard: false,
          backdrop: 'static',
          show    : false,
        });
        $('#revision-list tbody').on('click','tr td:not(:last-child)',function () {
					  $row = $(this).closest('tr')
            revision_pk =  $row.data("pk");
            url = $row.data('url');
            title_part = $row.children('td:nth-child(2)').html();

            $("#show-revision-modal").modal('show');

            $("#show-revision-modal .modal-title").html("Revision of" + title_part);
            $("#show-revision-modal .modal-body").load(url);
            $("#show-revision-modal .modal-header").addClass('bg-primary')

        });
    });
{% include 'exams/modals/adjust_modal_size.js' %}
</script>
{% with modal_id='show-revision-modal' no_footer=True %}
    {% include "exams/modals/common_edit_modal.html" %}
{% endwith %}

{% include 'exams/partials/initialize_revision_review.html' %}

{% with category_pk=exam.category.pk  parent_category_pk=exam.category.parent_category.pk %}
  {% include 'exams/partials/dynamic_sidebar.html' %}
{% endwith %}

{% endblock %}
