{% extends 'base_new.html' %}{% load static exam_utils %}
{% block title %}Fudul | {{ exam.name }}: List duplicates ({{ duplicate_containers.count }}){% endblock %}
{% block header_title %}
<h1>{{ exam.name }}: List duplicates ({{ duplicate_containers.count }})</h1>
{% with is_list_active=True %}
{% include 'exams/partials/exam_editor_buttons.html' %}
{% endwith %}
{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/toastr.min.css' %}">
{% endblock %}

{% block breadcrumb %}
      <li class="breadcrumb-item"><a href="{% url 'index' %}">Home page</a></li>
      <li class="breadcrumb-item"><a href="{% url 'exams:list_meta_categories' %}">Exams</a></li>
			{% for parent_category in exam.category.get_parent_categories %}
			<li class="breadcrumb-item"><a href="{% url 'exams:show_category' parent_category.get_slugs %}">{{ parent_category.name }}</a></li>
			{% endfor %}
			<li class="breadcrumb-item"><a href="{% url 'exams:show_category' category_slugs %}">{{ exam.category.name }}</a></li>
      <li class="breadcrumb-item"><a href="{% url 'exams:create_session' category_slugs exam.pk %}">{{ exam.name }}</a></li>
      <li class="breadcrumb-item"><a href="{% url 'exams:list_questions' category_slugs exam.pk %}">List</a></li>
      <li class="breadcrumb-item active">Duplicates</li>
{% endblock %}

{% block content %}
      <div class="card border">
        <div class="card-body">
          <div class="card-block">
            <p>Welcome to the <strong>Duplication Catcher</strong>.  This tool scans the question bank once everyday to look for questions that are similar.  You can either keep one verion of the question or ignore it.  By choosing to keep one version, all sources, subjects, exam types, corrections, and answers get merged, all with one click!</p>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <div class="card-block">
            {% for duplicate_container in duplicate_containers %}
            <div class="card duplicate-container border-bottom">
              <div class="card-body row">
                <div class="col-sm-9">
                  <h3 class="text-bold-600">Report #{{ duplicate_container.pk }}</h3>
                  <h5 class="text-bold-600"><a href="{% url 'exams:list_revisions' category_slugs exam.pk duplicate_container.primary_question.pk %}">Question #{{ duplicate_container.primary_question.pk }}</a></h5>
                  <p class="font-small-3">(<abbr class="primary-question">Primary question;</abbr> {{ duplicate_container.primary_question.get_answering_user_count }} users answered)</p>
                  <p>{{ duplicate_container.primary_question.best_revision.text|linebreaksbr }}</p>
                  <ul type="A">
                  {% for choice in duplicate_container.primary_question.best_revision.choice_set.order_by_alphabet %}
                    <li><span {% if choice.is_right %} data-toggle="tooltip" data-title="This choice is the right one" style="font-weight: 800;" class="success darken-4"{% endif %}>{{ choice.text }}</span></li>
                  {% endfor %}
                  </ul>
                  {% for duplicate in duplicate_container.duplicate_set.undeleted_question.select_for_list.order_by_question_pk %}
                  <h5 class="text-bold-600"><a href="{% url 'exams:list_revisions' category_slugs exam.pk duplicate.question.pk %}">Question #{{ duplicate.question.pk }}</a></h5>
                  <p class="font-small-3">(<strong class="danger darken-4">{{ duplicate.get_percentage }}% similar to the primary question</strong>; {{ duplicate.question.get_answering_user_count }} users answered)</p>
                  <p>{{ duplicate.question.best_revision.text|linebreaksbr }}</p>
                  <ul type="A">
                  {% for choice in duplicate.question.best_revision.choice_set.order_by_alphabet %}
                    <li><span {% if choice.is_right %} data-toggle="tooltip" data-title="This choice is the right one" style="font-weight: 800;" class="success darken-4"{% endif %}>{{ choice.text }}</span></li>
                  {% endfor %}
                  </ul>
                  {% endfor %}
                </div>
                <div class="col-sm-3 align-self-center border-left text-center">
                  <div class="btn-group-vertical">
                    {% for question in duplicate_container.get_questions %}
                    <button class="btn btn-success duplicate-decision" data-duplicate-container-pk="{{ duplicate_container.pk }}" data-question-pk="{{ question.pk }}" data-action="keep"><i class="ft-check-square"></i> Keep question #{{ question.pk }}</button>
                    {% endfor %}
                    <button class="btn btn-warning duplicate-decision" data-duplicate-container-pk="{{ duplicate_container.pk }}" data-action="decline"><i class="ft-delete"></i> Ignore</button>
                  </div>
                </div>
              </div>
            </div>
            {% empty %}
            <p>No duplicates for {{ exam.name }}.  Get back to the <a href="{% url 'exams:list_questions' category_slugs exam.pk %}">list of questions</a>.</p>
            {% endfor %}
          </div>
        </div>
    </div>
{% endblock %}
{% block customscript %}

<script src="{% static 'js/toastr.js' %}"></script>

<script>
    $(function () {
      $('[data-toggle="tooltip"]').tooltip();
      $('.primary-question').tooltip({title: "The primary question is the question against which other duplicate questions are compared.  This is notable when there were more than one duplicate question."})
      $('button.duplicate-decision').click(function(){
        $button = $(this)
        var action = $button.data('action');
        var question_pk = $button.data('question-pk');
        var container_pk = $button.data('duplicate-container-pk');
        $button.closest('.duplicate-container').remove();
        $.ajax({url: '{% url "exams:handle_duplicate" %}',
                data: {action: action, question_pk: question_pk, container_pk: container_pk},
                method: 'POST',
                success: function(data){
                  if (data.success == 1){
                    toastr.success("Report #" + container_pk + " was successfully handled.")
                  } else {
                    toastr.error(data.message)
                  }
                }
        });
      });
    });

{% include 'exams/modals/adjust_modal_size.js' %}
</script>
{% with category_pk=exam.category.pk  parent_category_pk=exam.category.parent_category.pk %}
  {% include 'exams/partials/dynamic_sidebar.html' %}
{% endwith %}
{% endblock %}
