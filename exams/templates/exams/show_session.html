<!DOCTYPE html>{% load static exam_utils %}
{% include 'partials/call_out.html' %}
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <title>Fudul | {{ session.exam.name }} session #{{ session.pk }}</title>
      	<script src="{% static 'limitless/assets/js/core/libraries/jquery.min.js' %}"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
        <script>
        paceOptions = {
            document: false,
            elements: ['#question-pool'],
            eventLag: false,
            restartOnPushState: false
        }
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js" integrity="sha384-5DyzDgtTHw1bbnR1u2aQPxi5+e1KVPsygV5Pioo5W+5ua3sN5AHF05kzM0QfXXqm" crossorigin="anonymous"></script>
        <link rel="shortcut icon" href="{% static 'img/logo-monkey.png' %}">
      	<link href="{% static 'limitless/assets/css/icons/icomoon/styles.css' %}" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Montserrat:300,300i,400,400i,500,500i%7COpen+Sans:300,300i,400,400i,600,600i,700,700i" rel="stylesheet">

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css" integrity="sha384-OHBBOqpYHNsIqQy8hL1U+8OXf9hH6QRxi0+EODezv82DfnZoV7qoHAZDwMwEJvSw" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/themes/black/pace-theme-loading-bar.min.css" integrity="sha384-46hxeX6k1sLo9XqANbmEmR8fjXTTcbm85rcnRtQQ1YkUMG+4xVnSgz718hNUu8Ak" crossorigin="anonymous">
        <link rel="stylesheet" type="text/css" href="{% static 'stack/fonts/font-awesome/css/font-awesome.min.css' %}">
        {% include 'partials/piwik.html' %}
        <style>
    body, html, #container{
        height: 100%
    }

    body{
        background: #fff;
        font-size: 17px;
        line-height: 1.8em;
        font-family: "Open Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        font-weight: 400;
    }

    .question-body .check i,
    .question-body .correct i{
      display: none;
    }

    #top-info, .tooltip-inner, #footer{
      background-color: #404E67;
    }

    body:not([data-session-mode="UNEXPLAINED"]) .question-body[data-was-solved="true"] .check i,
    body:not([data-session-mode="UNEXPLAINED"]) .question-body[data-was-solved="true"] .correct i,
    body[data-session-mode="UNEXPLAINED"][data-has-finished="true"] .question-body[data-was-solved="true"] .check i,
    body[data-session-mode="UNEXPLAINED"][data-has-finished="true"] .question-body[data-was-solved="true"] .correct i{
      display: inline-block;
    }

    #results, #end, #back{
      display: none;
    }

    body[data-session-mode=INCOMPLETE] #back,
    body[data-session-mode=SOLVED] #back{
      display: inline-block;
    }

    body:not([data-session-mode=INCOMPLETE]):not([data-session-mode=SOLVED])[data-has-finished=true] #results,
    body:not([data-session-mode=INCOMPLETE]):not([data-session-mode=SOLVED])[data-has-finished=false] #end{
      display: inline-block;
    }

    .tooltip.bs-tooltip-top .arrow::before{
      border-top-color: #404E67;
    }

    #top-info{
        font-size: 12pt;
        color: #FFF;
    }

    .top-question-id {
        line-height: 15px;
    }

    .option{
      cursor: pointer;
      display: inline-block;
      padding: 0 10px;
      /* For mobile devices */
      height: auto;
    }

    @media (min-width: 576px) {
      #footer .option{
        height: 38px;
      }
      #top-options .option{
        height: 32px;
      }
    }

    .separator{
        color: yellow;
    }

    #top-options {
        background-color: #929EB4;
        border-top: 1px solid #fff;
        line-height: 32px;
    }

    #mark.marked{
        font-weight: 700;
        padding: 0 9px;
        color: yellow;
    }

    #footer {
        color: #fff;
        line-height: 36px;
        font-size: 12pt;
        bottom: 0;
        position: fixed;
        border-top: solid 2px #fff;
        border-bottom: solid 2px #404E67;
        width: 100%;
    }

    /* Styling the exam name and "results" (which is a direct link) */
    #top-info a, a.option, #help-me-tooltip a{
        color: white;
    }

    #top-info a:hover, a.option:hover, #help-me-tooltip a:hover{
        text-decoration: none;
    }

    #contributors{
      cursor:zoom-in;
    }

    .strike{
        text-decoration: line-through;
    }

    td.check, #mark-loading{
      width: 16px;
    }

    .highlight {
        background: yellow;
    }

    .highlight.active{
        cursor: pointer;
    }

    .choice-text, .option, .navbar-brand, .mobile-slide{
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .question-choice {
        margin-right: 10px !important;
        word-wrap: break-word;
    }

    #submit, #explain{
        margin-top: 20px;
    }

    #submit{
        margin-left: 9px;
        background: #0067A9;
        color: #fff;
        font-size: 12pt;
        font-family: Arial, Verdana, Helvetica;
    }

    .tooltip-container, #mark-loading, .explanation-container, #explain, #submit, #contribute, .answer-correction-tooltip-container{
      display: none;
    }

    #question-container{
      margin-top: 20px;
    }

    #question-total, #question-sequence{
      display: inline-block;
    }

    .question-body{
      display: none;
    }

    .question-body.show{
      display: block;
    }

    .explanation-container{
      margin-top: 20px;
    }

    .explanation-content{
      overflow-x: auto;
    }

    .explanation-reference-header{
      font-size: 1.2rem;
    }

    .brand-logo{
      vertical-align: sub;
    }
    .brand-text{
      display: inline;
      padding-left: 10px;
      color: #1B2942;
      font-family: "Montserrat", Georgia, "Times New Roman", Times, serif;
      letter-spacing: 1px;
      font-size: 1.74rem;
      font-weight: 500;
    }

    .mobile-slide{
      height: 100%;
      width: 20%;
      position: fixed;
      z-index: 1;
    }

    .question-body.show, #submit{
      z-index: 2;
      position: relative;
    }

    #top-info, #top-options, #footer{
      z-index: 3;
    }

    #top-info, #top-options{
      position: relative;
    }

    .mobile-slide.next{
      right: 0
    }
    .mobile-slide.previous{
      left: 0
    }
  </style>
    </head>
    <body data-session-mode="{{ session.session_mode }}" data-has-finished="{% if session.has_finished %}true{% else %}false{% endif %}">
    <div class="container-fluid" id="container">
        <div class="d-sm-none mobile-slide previous" id="slide-previous"></div>
        <div class="d-sm-none mobile-slide next " id="slide-next"></div>
        <div id="top-info" class="row align-items-center">
            <div class ="col-sm-3 text-sm-left text-center">
              <a href="/" class="navbar-brand">
                <img alt="stack admin logo" src="{% static 'img/logo-monkey.png' %}" class="img-fluid brand-logo">
                <h2 class="brand-text">Fudul</h2></a>
            </div>
            <div class="ml-auto col-sm-6 text-center"> <a target="_blank" href="{% url 'exams:create_session' session.exam.category.get_slugs session.exam.pk %}">{{ session.exam.name }}</a> <span class="separator">•</span> Session id: <span id="session-pk">{{ session.pk }}</span> ({{ session.get_session_mode_display }})<br> Question id: <a target="_blank" href="{% url 'exams:list_revisions' session.exam.category.get_slugs session.exam.pk current_question.pk %}" id="question-pk">{{ current_question.pk }}</a> </div>
            <div class="col-sm-3 top-question-id font-weight-bold text-sm-right text-center my-2 mb-sm-0"><div id="question-sequence">{{ current_question_sequence }}</div> of <div id="question-total">{{ session.get_questions.count }}</div></div>
        </div>
        <div id="top-options" class="row text-center align-items-center">
          <div class="col-sm-6 text-sm-left">
               <div class="option" id="contribute">
                   <a data-placement="left" data-toggle="tooltip" title=" If you have any improvements on the question you can help us with, please submit it here.Your edits will be quickly available to public."> <i class="icon-pencil"></i> Edit</a>

               </div>
          </div>
          <div class="col-sm-6 text-sm-right">
               <div data-toggle="tooltip" data-html="true" data-title="<strong>Hint:</strong> you can also press <kbd>Alt+M</kbd> to toggle question mark." id="mark" class="option{% if current_question|is_question_marked:user %} marked{% endif %}">
                  <img id="mark-loading" src="{% static 'img/ajax-loader.gif' %}">
                  <i id="mark-icon" class="icon-flag7"></i> Mark
               </div>
          </div>
        </div>

        <div id="question-container">
          <div id="question-pool" class="mx-4 mx-sm-0">
            <!--AJAX will insert questions here-->
          </div>
          <button {% if current_question|was_solved_in_session:session %}style="display: none;"{% endif %} type="button" id="submit" class="btn">Submit <i class=" icon-circle-right2"></i></button>
          <button class="btn btn-outline-primary" id="explain"><i class=" icon-brain"></i> Improve this explanation!</button>
        </div>
        <div id="footer" class="row text-center font-weight-bold">
          <div class="col-sm-6 text-sm-left order-2 order-sm-1">
           <a id="back" class="float-left float-sm-none option" href="{% url 'exams:create_session' session.exam.category.get_slugs session.exam.pk %}"><i class="icon-exit3"></i> Back</a>
           <a id="results" class="float-left float-sm-none option" href="{% url 'exams:show_session_results' session.exam.category.get_slugs session.exam.pk session.pk %}"><i class="fa fa-check-square-o" aria-hidden="true"></i> Results</a>
           <div id="end" class="float-left float-sm-none option"><i class="icon-exit3"></i> End</div>
           <div id="contributors" class="float-right float-sm-none option"><i class="icon-stars"></i> Contributors</div>
           <div id="help-me" class="float-right float-sm-none option d-none d-sm-inline-block"><i class="fa fa-comment"></i> Get help</div>
          </div>
          <div class="col-sm-6 text-sm-right order-1 order-sm-2">
            <div class="row justify-content-end no-gutters">

              <div class="col-sm-auto col-5">
                 <div data-action="previous" data-toggle="tooltip" data-html="true" data-title="<strong>Hint:</strong> You can also <span class='d-inline d-sm-none'>tap the left screen side</span><span class='d-none d-sm-inline'>press the left keyboard arrow (<kbd>←</kbd>)</span> to go back." id="previous" class="float-left float-sm-none option"><i class="icon-circle-left2" aria-hidden="true"></i> Previous</div>
              </div>
              <div class="col-sm-auto col-2">
                 <div id="open-navigation" class="option"><i class="icon-list3" aria-hidden="true"></i> <span class="d-none d-sm-inline">Navigate</span></div>
              </div>
              <div class="col-sm-auto col-5">
                 <div data-action="next" data-toggle="tooltip" data-html="true" data-title="<strong>Hint:</strong> You can also <span class='d-inline d-sm-none'>tap the right screen side</span><span class='d-none d-sm-inline'>press the right keyboard arrow (<kbd>→</kbd>)</span> to go next." id="next" class="float-right float-sm-none option">Next <i class="icon-circle-right2" aria-hidden="true"></i></div>
              </div>
          </div>
        </div>
      </div>
        <link rel="stylesheet" href="{% static 'css/toastr.min.css' %}">
        <script src="{% static 'js/toastr.js' %}"></script>
        <script>
    toastr.options.positionClass = "toast-top-left";
    active_keys = {};
    was_solved_cell = '<i class="fa fa-check-square" aria-hidden="true"></i>';
    is_marked_cell = '<i class="icon-flag7" aria-hidden="true"></i>';

    function updateData(){
        current_sequence =  parseInt($("#question-sequence").html());
        data = {question_pk: $(".question-body.show").data('question-pk'),
                session_pk: $("#session-pk").html()}
    }

    function handleMarked(is_marked){
        $markButton = $("#mark");
        if (is_marked){
            $markButton.addClass("marked");
        } else {
            $markButton.removeClass("marked");
        }
    }

    function showQuestion(targeted_sequence){
      $question = $("#question-pool [data-question-sequence=" + targeted_sequence + "]")
      // Add 'show' class to the current question
      $question.addClass("show");
      // Remove 'show' class from other questions
      $(".question-body").not($question).removeClass('show');
      $("#question-sequence").html($question.data('question-sequence'));
      $("#question-pk").html($question.data('question-pk'));
      list_revision_url = $question.data('list-revision-url')
      $("#question-pk").attr('href', list_revision_url);
      updateData();
      initializeInteractions();
      handleMarked($question.data('is-marked'));
      history.pushState({url: $question.data('url')}, '', $question.data('url'));
    }

    function navigate() {
        action = $(this).data('action');

        animation_events = 'webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend';
        // If no previous or no next, just return
        if (current_sequence == 1 && action == 'previous'){
          $("#question-sequence").addClass("animated flash").css('color', 'yellow');
          $("#question-sequence").one(animation_events, function(){
            $(this).removeClass().css('color', '');
          });
          return
        } else if (current_sequence == total && action == 'next'){
          $("#question-total").addClass("animated flash").css('color', 'yellow');
          $("#question-total").one(animation_events, function(){
            $(this).removeClass().css('color', '');
          });
          return
        }

        if (action == 'next' ){
          targeted_sequence = current_sequence + 1;
        } else if (action == 'previous' ){
          targeted_sequence = current_sequence - 1;
        }

        // Upon navigation, hide previous voting tooltips
        $(".answer-correction-notification").tooltip('hide');

        showQuestion(targeted_sequence);

    }

    function toggleMarked() {
        $("#mark-icon").hide();
        $("#mark-loading").show();
        $.ajax({
            url: "{% url 'exams:toggle_marked' %}",
            type: 'POST',
            data: data,
            cache: false,
            success: function(data){
               $question = $(".question-body.show");
               sequence = $question.data('question-sequence')
               $question_row = $('.navigate-row[data-question-sequence="' + sequence + '"]');
               $question.data('is-marked', data.is_marked);
               handleMarked(data.is_marked);
               if (data.is_marked){
                 $question_row.find('td.is_marked').html(is_marked_cell);
                 _paq.push(['trackEvent', 'show_session', 'mark-question', 'add-mark']);
               } else {
                 $question_row.find('td.is_marked').html("");
                 _paq.push(['trackEvent', 'show_session', 'mark-question', 'remove-mark']);
               }
               $("#mark-icon").show();
               $("#mark-loading").hide();

            }
        });
    }

    function toggleChoices() {
        var $choice = $(this);
        if ($choice.is(":checked")) {
            // other sister choices to be removed
            $otherChoices = $choice.closest('.question-body').find('.question-choice').not($choice);
            // If a choice is checked, it is no longer striked.
            if ($choice.closest('tr').find('.choice-text.strike').length){
              $choice.closest('tr').find('.choice-text.strike').removeClass('strike');
              submitHighlight();
            }
            $otherChoices.prop("checked", false);
        } else {
            $choice.prop("checked", false);
        }
    }

    function removeHighlight(){
      $(this).contents().unwrap();
      submitHighlight();
    }

    function highlightText() {
        var selection = window.getSelection().toString();
        if (selection.length >= 3) {
            var escapedSelection = $("<div>").text(selection).html();
            var replacement = $('<span></span>').addClass('active highlight').html(selection);
            var replacementHtml = replacement.prop('outerHTML');
            $(this).html($(this).html().replace(escapedSelection, replacementHtml));
            // Bind only once
            $(".question-body.show .highlight").off('click').on('click', removeHighlight);
            submitHighlight();
        }

    }

    function updateCorrectionTooltip(html, choice_pk){
      pk_selector = "[data-choice-pk=" + choice_pk + "]";
      $choice_row = $(".question-body.show tr" + pk_selector);
      $choice_row.find('.answer-correction-notification').tooltip('dispose');
      $choice_row.find(".answer-correction-tooltip-container").remove();
      $choice_row.find('.check').append(html);
      tooltip = $choice_row.find('.answer-correction-tooltip-body').get()[0];
      $choice_row.find('.answer-correction-notification').tooltip({html: true,
                                                                   title: tooltip,
                                                                   trigger: 'click'})
    }

    function handleCorrectionVotes(){
      $(".support-correction, .oppose-correction").click(function(){
        action = $(this).data('action');
        choice_pk = $(this).data('choice-pk');
        url = "{% url 'exams:correct_answer' %}?" + $.param({choice_pk: choice_pk})

        $.ajax({
            url: url,
            type: 'POST',
            data: {'action': action},
            success: function(data){
              if (data.success == 1){
                toastr.success("Your vote was submitted.")
                updateCorrectionTooltip(data.correction_html, choice_pk);
              } else {
                toastr.error(data.message)
              }
            }
        });
      });
    }

    function controlExplanation(){
      was_solved = $(".question-body.show").data('was-solved');
      if (!was_solved || (session_mode == 'UNEXPLAINED' && !$('body').data('has-finished'))){
        $(".question-body.show .explanation-container, #explain").hide()
      } else if ($('.question-body.show .explanation-content').text().length){
        $("#explain").show().html("Improve this explanation!");
        $(".question-body.show .explanation-container").show();
      } else {
        $(".question-body.show .explanation-container").hide();
        $("#explain").show().html("Add an explanation!");
      }
    }

    function controlNavigationButtons(){
      // We dispose in all cases to allow for changes, if indicated,
      // to be applied.
      $("#next").tooltip('dispose');

      if (current_sequence == total){
        $("#next").css('cursor', 'not-allowed');
        // select whatever button that's visible
        button_name = $("#end:visible, #results:visible").html();
        $("#next").tooltip({title: 'This is the last question.  You can click <kbd>' + button_name + '</kbd> to end this session.',
                            html: true})
      } else {

        $("#next").tooltip();
        $("#next").css('cursor', 'pointer');
      }

      if (current_sequence == 1){
        $("#previous").css('cursor', 'not-allowed');
      } else {
        $("#previous").css('cursor', 'pointer');
      }
    }

    function initializeInteractions() {
        // Check whether we have any unsolved questions. Changing
        // data-has-finished to true will cause expalantions to show
        // right away in UNEXPLAINED sessions.
        // This also affects #results and #end buttons.
        if (!$('.question-body[data-was-solved="false"]').length){
          $('body').data('has-finished', true).attr('data-has-finished', true);
        }

        $question = $(".question-body.show");

        // Mark row as active
        sequence = $question.data('question-sequence');
        question_row = $('.navigate-row[data-question-sequence="' + sequence + '"]');
        question_row.addClass('table-active');
        $('.navigate-row').not(question_row).removeClass('table-active');

        controlNavigationButtons();

        // Show contributors as a tooltip
        $("#contributors").tooltip('dispose');
      	$("#contributors").off('click').click(function(){
      	    _paq.push(['trackEvent', 'show_session', 'see-contributors', 'see-contributors']);
      	});
        $("#contributors").tooltip({html: true,
                                    trigger: 'click',
                                    title: $(".question-body.show .tooltip-body").get()[0]})

        // Disable interaction if question was solved.

        controlExplanation();
        was_solved = $question.data('was-solved');
        if (was_solved){
          $("#contribute").show();
          $("#submit").hide();
          $question.find(".highlight").removeClass('active').off('click');
          $question.find(".question-choice").prop("disabled", "disabled");
        } else {
            $("#contribute").hide();
            $("#submit").show();
            // We turn off handlers first to ensure they don't get
            // triggered more than once as the user navigates and
            // binds the handlers.
            $question.find(".question-text").off('mouseup touchend').on('mouseup touchend', highlightText);
            $question.find(".question-choice").off('change').on('change', toggleChoices);
            $question.find(".highlight").addClass('active').off('click').on('click', removeHighlight);
            $(".question-body.show .choice-text").off('click').on('click', function() {
                if (!$(this).hasClass("strike")){
                   // If a choice is striked, it is no longer checked.
                    $(this).closest("tr").find(".question-choice").prop('checked', false);
                }
                $(this).toggleClass("strike");
                submitHighlight();
            });
        }
    }

    function submitHighlight(){
      data.best_latest_revision_pk = $(".question-body.show").data('best-latest-revision-pk');
      data.highlighted_text = $(".question-body.show .question-text").html();
      stricken_choice_pks = $('.question-body.show .choice-text.strike').map(function(){return $(this).closest('tr').data('choice-pk')}).get();
      data.stricken_choice_pks = JSON.stringify(stricken_choice_pks);

      $.ajax({
          url: "{% url 'exams:submit_highlight' %}",
          type: 'POST',
          data: data
      });
    }

    function submitChoice() {
        $(this).hide();
        $question = $(".question-body.show");

        // if question was previously solved, don't submit.
        if ($question.data('was-solved')){
          return
        }
        // Mark question as solved
        // We also set was-solved using .attr() to change the DOM and
        // be able to apply CSS.
        $question.data('was-solved', true).attr('data-was-solved', true);
        sequence = $question.data('question-sequence')
        question_row = $('.navigate-row[data-question-sequence="' + sequence + '"]');
        question_row.find('td.was_solved').html(was_solved_cell);

        // Disable choices upon submission
        $question.find(".question-choice").prop("disabled", "disabled")
        // Disable interactions after submission
        $question.find(".highlight").removeClass("active");
        $question.find(".question-text, .question-choice, .choice-text, .highlight").off();

        $checkedChoice = $question.find(".question-choice:checked");
        // Do we have a choice, or was it skipped?
        if ($checkedChoice.length) {
            // We store choice pk at the row.
            choice_pk = $checkedChoice.closest('tr').data("choice-pk");
        } else {
            choice_pk = null;
        }
        data.choice_pk = choice_pk;

        $.ajax({
            url: "{% url 'exams:submit_answer' %}",
            type: 'POST',
            data: data,
            cache: false,
            success: function(data) {
                if (data.success) {
                    if (!choice_pk){
                        toastr.warning('You skipped this question');
                    }

                    controlExplanation();
                    $("#contribute").show();
                } else {
                  toastr.error(data.message);
                }
            }
        });

    }

    function updateFooterMargins() {
      $("#question-container").css({
        'padding-bottom': $('#footer').height() + 20
      })
    }

    function initializeKeyboard(){
      $(document).keydown(function(e){
        // record active keys so we can handle a combination of keys
        active_keys[e.which] = true;

        // check which key we got
        if (active_keys[37]) { // left key
          $("#previous").trigger('click');
        	_paq.push(['trackEvent', 'show_session', 'navigation', 'keyboard-previous']);
        } else if (active_keys[39]) {  // right key
          $("#next").trigger('click');
        	_paq.push(['trackEvent', 'show_session', 'navigation', 'keyboard-next']);
        } else if (active_keys[18] && active_keys[77]) { // alt + m
          _paq.push(['trackEvent', 'show_session', 'mark-question', 'keyboard-mark']);
          $('#mark').trigger('click');
        } else if (active_keys[17] && active_keys[13]) { // ctrl + enter
          _paq.push(['trackEvent', 'show_session', 'mark-question', 'keyboard-submit']);
          $("#submit").trigger('click');
        } else if (active_keys[17] && active_keys[38] || active_keys[17] && active_keys[40]){ // ctrl + up or ctrl + down
          total_choices = $('.question-body.show .question-choice').length
          $checked_choice = $('.question-body.show .question-choice:enabled:checked')
          if ($checked_choice.length){
            choice_index = $('.question-body.show .question-choice').index($checked_choice);
            if (active_keys[38] && choice_index == 0){ // Up while at top
              // We are at the topmost choice, we cannot go up.
              return
            } else if (active_keys[40] && choice_index == (total_choices -1)){ // Up while at bottom
              // We are at the bottom most choice, we cannot go futher down
              return
            } else {
              if (active_keys[40]){ // down
                _paq.push(['trackEvent', 'show_session', 'navigation', 'keyboard-down']);
                target_index = choice_index + 1
              } else if (active_keys[38]){ // up
                _paq.push(['trackEvent', 'show_session', 'navigation', 'keyboard-up']);
                target_index = choice_index - 1;
              }
            }
          } else {
            // If no choice is already checked, arrows always select the first choice.
            target_index = 0;
          }
          target_choice = $('.question-body.show .question-choice:enabled').get(target_index)
          $(target_choice).prop('checked', true).trigger('change');
        }
      });
      $(document).keyup(function (e) {
          // remove keys that are no longer active;
          delete active_keys[e.which];
      });
    }

    $(function() {
        initializeKeyboard();
        // variable used by many functions
        total = $("#question-total").html();
        session_mode = $('body').data('session-mode');

        // Initialize tooltips
        $('[data-toggle="tooltip"]').tooltip()
        help_me_tooltip = $("#help-me-tooltip").get()[0];
        $("#help-me").tooltip({html: true,
                               trigger: 'click',
                               title: help_me_tooltip})
         $("#help-me").click(function(){
           _paq.push(['trackEvent', 'show_session', 'click-get-help', 'click-get-help']);
         });

        pool_url = "{% url 'exams:list_session_questions' %}?" + $.param({ {% if current_question_pk %}question_pk: {{ current_question_pk }},{% endif %}
                                                                          session_pk: {{ session.pk }}});
        $("#question-pool").load(pool_url, function(){

          // construct navigation-table
          for (var i = 1; i <= {{ session.get_questions.count }}; i++) {
             $question = $('.question-body[data-question-sequence="' + i.toString() + '"]')
             question_pk = $question.data('question-pk');
             was_solved = $question.data('was-solved') ? was_solved_cell : '';
             is_marked = $question.data('is-marked')  ? is_marked_cell : '';
             $("#navigation-table tbody").append("<tr class='navigate-row text-center' data-question-sequence='" + i.toString() + "'><td>" + i.toString() + "</td><td class='d-sm-table-cell d-none'>" + question_pk.toString() + "</td><td class='d-sm-table-cell d-none is_marked'>" + is_marked + "</td><td class='was_solved'>" + was_solved +"</td></tr>")
          }

          $('.navigate-row').click(function(){
            _paq.push(['trackEvent', 'show_session', 'navigation', 'click-navigate-row']);
            targeted_sequence = $(this).data('question-sequence');
            showQuestion(targeted_sequence);
          });

          updateData();
          initializeInteractions();
          $(".correct i").click(function () {
              _paq.push(['trackEvent', 'show_session', 'answer_correction', 'click-correct']);
              $("#correct-answer-modal").modal('show');
              choice_pk = $(this).closest('tr').data('choice-pk')
              url = "{% url 'exams:correct_answer' %}?" + $.param({choice_pk: choice_pk})
              $("#correct-answer-modal .modal-body").load(url);
          });

          $('.question-body .answer-correction-notification').each(function(){
            $(this).click(function(){
              _paq.push(['trackEvent', 'show_session', 'answer_correction', 'click-notification']);
              $('.answer-correction-notification').not(this).tooltip('hide');
            });
            tooltip = $(this).closest("td").find('.answer-correction-tooltip-body').get()[0];
            $(this).tooltip({html: true,
                             trigger: 'click',
                             title: tooltip})
          });

          handleCorrectionVotes();

        });
        updateFooterMargins();
        $(window).resize(updateFooterMargins);

        $(".mobile-slide").click(function(){
          if ($(this).hasClass('previous')){
            $("#previous").trigger('click');
	    _paq.push(['trackEvent', 'show_session', 'navigation', 'slide-previous']);
          } else if ($(this).hasClass('next')){
            $("#next").trigger('click');
	    _paq.push(['trackEvent', 'show_session', 'navigation', 'slide-next']);
          }
        });

        $("#end").click(function(){
          $("#confirm-end-modal a.submit-button").prop("href", "{% url 'exams:show_session_results' session.exam.category.get_slugs session.exam.pk session.pk %}");
          $("#confirm-end-modal").modal('show');
        });
        $('#submit').click(submitChoice);
        $('#previous, #next').click(navigate);
        $('#mark').click(toggleMarked);
            // initialize project edit modal
        $('#modify-question-modal, #explain-question-modal, #navigate-modal').modal({
          keyboard: false,
          backdrop: 'static',
          show    : false,
        });
        $("#open-navigation").click(function(){
          _paq.push(['trackEvent', 'show_session', 'navigation', 'open-navigation']);
          $('#navigate-modal').modal('show');
        });
        $("#contribute").click(function () {
            $("#modify-question-modal").modal('show');
            url = "{% url 'exams:contribute_revision' %}?" + $.param({question_pk: data.question_pk})
            $("#modify-question-modal .modal-body").load(url);
        });
        // initialize project edit modal
        $("#explain, a.explain").click(function () {
            $("#explain-question-modal").modal('show');
            url = "{% url 'exams:contribute_explanation' %}?" + $.param({question_pk: data.question_pk})
            $("#explain-question-modal .modal-body").load(url);
        });

        modal_selectors = '#explain-question-modal, #modify-question-modal, #correct-answer-modal';

        $(modal_selectors).on("hidden.bs.modal", function(){
          initializeKeyboard();
        });

        $(modal_selectors).on("show.bs.modal", function(){
          $(document).off('keydown keydup');
        });

    });

        </script>

        {% with modal_id='confirm-end-modal' is_small=True confirm_link=True modal_title="End session" modal_content="<i class='text-danger icon-exit3'></i> Are you sure you want to end this session, and mark unsubmitted questions as unsolved?" %}
            {% include "exams/modals/common_modal_v4.html" %}
        {% endwith %}

        {% with modal_id='modify-question-modal' no_footer=True modal_title="Edit the question" %}
             {% include "exams/modals/common_modal_v4.html" %}
        {% endwith %}

        {% with modal_id='explain-question-modal' no_footer=True modal_title="Explain the answer" %}
            {% include "exams/modals/common_modal_v4.html" %}
        {% endwith %}

        {% with modal_id='correct-answer-modal' no_footer=True modal_title="Correct the answer" %}
            {% include "exams/modals/common_modal_v4.html" %}
        {% endwith %}

        {% with modal_id='navigate-modal' no_footer=True modal_title="Navigate session" modal_content="<table id='navigation-table' class='table table-sm table-hover'><thead class='text-center thead-dark'><tr><th>Sequence</th><th class='d-sm-table-cell d-none'>ID</th><th class='d-sm-table-cell d-none'>Marked?</th><th>Answered?</th></tr></thead><tbody></tbody></table>" %}
            {% include "exams/modals/common_modal_v4.html" %}
        {% endwith %}

        <div class="d-none">
          <div id="help-me-tooltip">
            <p>Fudul is made better by your feedback and ideas!  Contact us right now:</p>
            <div class="row justify-content-center">
              <div class="col-12">
                <a target="_blank" href="https://t.me/FudulBot"><i class="fa fa-2x fa-telegram"></i><br>Telegram Live Chat</a>
              </div>
            </div>
            <div class="row justify-content-center mt-3 mb-2">
              <div class="col-12">
                <a href="mailto:support@fudulbank.com"><i class="fa-2x  icon-envelop5"></i><br>Support Email</a>
              </div>
            </div>
          </div>
        </div>
    </body>
</html>
