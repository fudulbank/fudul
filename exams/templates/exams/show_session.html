<!DOCTYPE html>{% load static exam_utils %}
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Fudul | {{ session.exam.name }} session #{{ session.pk }}</title>
      	<script type="text/javascript" src="{% static 'limitless/assets/js/core/libraries/jquery.min.js' %}"></script>
      	<script type="text/javascript" src="{% static 'limitless/assets/js/core/libraries/bootstrap.min.js' %}"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery.tooltipster/4.2.5/js/tooltipster.bundle.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/offline-js/0.7.19/offline.min.js"></script>
      	<link href="{% static 'limitless/assets/css/icons/icomoon/styles.css' %}" rel="stylesheet" type="text/css">
        <link href="https://cdn.jsdelivr.net/jquery.tooltipster/4.2.5/css/tooltipster.bundle.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdn.jsdelivr.net/jquery.tooltipster/4.2.5/css/plugins/tooltipster/sideTip/themes/tooltipster-sideTip-shadow.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/offline-js/0.7.19/themes/offline-theme-chrome.css" rel="stylesheet" type="text/css">
        <link href="{% static 'limitless/assets/css/bootstrap.css' %}" rel="stylesheet" type="text/css">
        {% include 'partials/piwik.html' %}
        <style>
    body, html, #container{
        height: 100%
    }

    body{
        background: #fff;
        font-size: 12pt;
        font-family: Arial,Verdana,Helvetica;
    }

    .top-info{
        background-color: #0067A9;
        height: 50px;
        font-size: 12pt;
        color: #FFF;
    }

    .top-exam-details {
        position: absolute;
        left: 47%;
        margin-left: -50px;
        padding: 4px 0;
    }

    .top-question-id {
        font-weight: 700;
        line-height: 15px;
        margin-top: 18px;
    }

    .separator{
        color: yellow;
    }

    .top-options {
        background-color: #7cafe8;
        border-top: 1px solid #fff;
        height: 32px;
        line-height: 32px;
    }

    #mark.marked{
        font-weight: 700;
        padding: 0 9px;
        color: yellow;
    }

    #footer {
        color: #fff;
        font-weight: 700;
        line-height: 36px;
        height: 38px;
        font-size: 12pt;
        background-color: #0067A9;
        bottom: 0;
        position: fixed;
        border-top: solid 2px #fff;
        border-bottom: solid 2px #0067A9;
        width: 100%;
    }

    .option{
        padding: 0 10px;
        /*vertical-align: top;*/
    }

    .border-left{
        border-left: solid 2px #fff;
    }

    .border-right{
        border-right: solid 2px #fff;
    }

    #footer .option a{
        color: white;
    }

    .strike{
        text-decoration: line-through;
    }

    td.check, #mark-loading{
      width: 16px;
    }

    .highlight {
        background: yellow;
        cursor: pointer;
    }

    .choice-text {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .question-choice {
        margin-right: 10px !important;
        word-wrap: break-word;
    }

    #submit, #next{
        margin-left: 9px;
        background: #0067A9;
        color: #fff;
        font-size: 12pt;
        font-family: Arial,Verdana,Helvetica;
        margin-bottom: 45px;
    }

    #tooltip-container, #mark-loading{
      display: none;
    }

    #next, #previous, #mark, #contribute {
        cursor: pointer;
    }

    .correct {
      color: green;
    }

    .incorrect {
      color: red;
    }
        </style>
    </head>
    <body>
    <div id="container">
        <div class="top-info">
            <div class="top-exam-details text-center"> {{ session.exam.name }} <span class="separator">â€¢</span> Session id: {{ session.pk }}<br> Question id: <span id="question-id">{{ question.pk }}</span> </div>
            <div class="top-question-id pull-right text-right option"><span id="question-sequence">{{ question_sequence }}</span> of {{ session.questions.count }}</div>
        </div>
        <div class="top-options text-left">
            <div class="pull-left text-left">
               <div class="option border-right border-left" id="contribute">
                  <i class="icon-pencil"></i> Contribute
               </div>
            </div>
            <div class="pull-right text-right">
               <div id="mark" class="option border-right border-left{% if question|is_question_marked:user %} marked{% endif %}">
                  <img id="mark-loading" src="{% static 'img/ajax-loader.gif' %}">
                  <i id="mark-icon" class="icon-flag7"></i> Mark
               </div>
            </div>
        </div>

        <div id="question-container">
            {% include 'exams/partials/session-question.html' %}
        </div>

        <button {% if question|was_solved_in_session:session %}style="display: none;"{% endif %} type="button" id="submit" class="btn">Submit <i class=" icon-circle-right2"></i></button>

        <div id="footer" class="text-center">
           <div class="option pull-left border-right border-left"><a href="{% url 'exams:create_session' session.exam.category.get_slugs session.exam.pk %}"><i class="icon-exit3"></i> Exit</a></div>
           <div class="option pull-left border-right" id="contributors" data-tooltip-content="#tooltip-body"><i class="icon-stars"></i> Contributors</div>
           <div data-action="next" id="next" class="option pull-right border-right border-left">Next <i class=" icon-circle-right2"></i></div>
           <div data-action="previous" id="previous" class="option pull-right border-left"><i class=" icon-circle-left2"></i> Previous</div>
        </div>
      </div>
        <link rel="stylesheet" href="{% static 'css/toastr.min.css' %}">
        <script src="{% static 'js/toastr.js' %}"></script>
        <script>
    toastr.options.positionClass = "toast-top-left";

    function updateData(){
        data = {question_pk: $("#question-body").data('question-pk'),
                session_pk: $("#question-body").data('session-pk')}
    }

    function handleMarked(is_marked){
        $markButton = $("#mark");
        if (is_marked){
            $markButton.addClass("marked");
        } else {
            $markButton.removeClass("marked");
        }
    }

    function navigate() {
        action = $(this).data('action');
        data.action = action;
        $.ajax({
            url: "{% url 'exams:navigate_question' %}",
            type: 'POST',
            data: data,
            cache: false,
            success: function(data){
                $("#question-container").html(data.question_body);
                $("#question-sequence").html(data.question_sequence);
                $("#question-id").html(data.question_pk);
                // This changes the url without actually reloading the page.
                history.pushState({url: data.url}, '', data.url);

                initializeInteractions();
                handleMarked(data.is_marked);
                updateData();

            }
        });
    }

    function toggleMarked() {
        $("#mark-icon").hide();
        $("#mark-loading").show();
        $.ajax({
            url: "{% url 'exams:toggle_marked' %}",
            type: 'POST',
            data: data,
            cache: false,
            success: function(data){
               handleMarked(data.is_marked);
               $("#mark-icon").show();
               $("#mark-loading").hide();

            }
        });
    }

    function toggleChoices() {
        var $choice = $(this);
        if ($choice.is(":checked")) {
            // other sister choices to be removed
            $otherChoices = $choice.closest('#question-container').find('.question-choice').not($choice);
            // If a choice is checked, it is no longer striked.
            $choice.closest('tr').find('.choice-text').removeClass('strike');
            $otherChoices.prop("checked", false);
        } else {
            $choice.prop("checked", false);
        }
    }

    function highlightText() {
        var selection = window.getSelection().toString();
        if (selection.length >= 3) {
            var escapedSelection = $("<div>").text(selection).html();
            var replacement = $('<span></span>').addClass('highlight').html(selection);
            var replacementHtml = replacement.prop('outerHTML');
            $(this).html($(this).html().replace(escapedSelection, replacementHtml));
        }
        $(".highlight").click(function() {
            $(this).removeClass("highlight");
        });
    }

    function initializeInteractions() {
        $("#contributors").tooltipster({theme: 'tooltipster-shadow', contentCloning: true});
        was_solved = $("#question-body").data('was-solved');
        if (was_solved){
          $("#submit").hide();
          $(".question-choice").prop("disabled", "disabled");
        } else {
            $("#submit").show();
            $(".question-text").mouseup(highlightText);
            $('.question-choice').change(toggleChoices);
            $(".choice-text").click(function() {
                if (!$(this).hasClass("strike")){
                   // If a choice is striked, it is no longer checked.
                    $(this).closest("tr").find(".question-choice").prop('checked', false);
                }
                $(this).toggleClass("strike");
            });
        }
    }

    function submitChoice() {
        $(this).hide();

        // Disable choices upon submission
        $(".question-choice").prop("disabled", "disabled")
        // Disable interactions after submission
        $(".question-text, .question-choice, .choice-text, .highlight").off();

        $checkedChoice = $('.question-choice:checked');
        // Do we have a choice, or was it skipped?
        if ($checkedChoice.length) {
            // We store choice pk at the row.
            choice_pk = $checkedChoice.closest('tr').data("choice-pk");
        } else {
            choice_pk = null;
        }
        data.choice_pk = choice_pk;
        $.ajax({
            url: "{% url 'exams:submit_answer' %}",
            type: 'POST',
            data: data,
            cache: false,
            success: function(data) {
                if (data.success) {
                    if (!choice_pk){
                        toastr.warning('You skipped this question');
                    }

                    if (data.right_choice_pk == null){
                      toastr.warning("We don't have the right answer for this question.");
                    } else if (typeof data.right_choice_pk !== "undefined"){
                      pk_selector = "[data-choice-pk=" + data.right_choice_pk + "]";
                      $correct_row = $("#question-body tr" + pk_selector);
                      $correct_row.find("td.check i").addClass("icon-checkmark2 correct")
                      $incorrect_rows = $("#question-body tr").not(pk_selector);
                      $incorrect_rows.find("td.check i").addClass("icon-cross3 incorrect");
                    }

                    if (data.explaination){
                      $("#question-container").append(data.explaination);
                    }
                } else {
                  toastr.error(data.message);
                }
            }
        });
    }
    $(function() {
        updateData();
        initializeInteractions();
        $('#submit').click(submitChoice);
        $('#previous, #next').click(navigate);
        $('#mark').click(toggleMarked);
    });
        </script>
    </body>
</html>
