{% extends 'base_new.html' %}{% load exam_utils staticfiles bootstrap3 %}

{% block title %}Fudul | Previous sessions {% endblock %}

{% block head %}
<style>
tr td:last-child{
  text-align: center;
}

.tooltip ul{
  text-align: left;
}
</style>
<link rel="stylesheet" href="{% static 'css/toastr.min.css' %}">
{% endblock %}

{% block header_title %}
<h1>Previous sessions</h1>
{% endblock %}

{% block breadcrumb %}
      <li class="breadcrumb-item"><a href="{% url 'index' %}">Home page</a></li>
      <li class="breadcrumb-item"><a href="{% url 'exams:list_meta_categories' %}">Exams</a></li>
      <li class="breadcrumb-item active">Previous sessions</li>
{% endblock %}

{% block content %}
<div class="card">
  <div class="card-body">
    {% if sessions.exists %}
    <div class="card-block">
      <button data-toggle="tooltip" data-html="true" title="<div style='direction: rtl'>ÙˆÙ‡Ù…Ø³ Ù„ÙŠ Ù‚Ø§Ù„ÙŠ Ø§Ù„Ø­Ù‚ Ø¹Ù„ÙŠÙ‡<br>Ù†Ø³ÙŠØª Ø³Ø§Ø¹ØªÙ‡Ø§ Ø¨Ø¹Ø¯Ù†Ø§ Ù„ÙŠÙ‡ ğŸ¶</div>" id="delete-all-sessions" class="btn btn-danger" style="float: right;"><i class="ft-trash-2"></i> Forgive me all previous sessions</button>
    </div>
    {% endif %}
    <div class="card-block">
      <table class="table table-striped table-bordered datatable responsive" width="100%">
         <thead>
           <tr>
             <th class="all">Session</th>
             <th>Date</th>
             <th># questions</th>
             <th>Score</th>
             <th class="all">Actions</th>
           </tr>
         </thead>
         <tbody>
         {% for session in sessions %}
         <tr data-pk="{{ session.pk }}">
             <td data-html="true" data-toggle="tooltip" title="{{ session.get_questions.count }} questions on: <ul>{% for subject in session|get_session_subjects %}<li>{{ subject.name }}</li>{% endfor %}</ul>"><a href="{% url 'exams:show_session' session.exam.category.get_slugs session.exam.pk session.pk %}">{{ session.exam.name }} ({{ session.pk }})</a></td>
             <td data-order="{{ session.submission_date|date:'U' }}">{{ session.submission_date }}</td>
             <td>{{ session.get_questions.count }}</td>
             <td class="text-center">
         {% if session.session_mode == 'SOLVED' %}
             <span data-toggle="tooltip" title="Solved sessions have no scores.">N/A<span>
         {% elif session.has_finished %}
         {% with score=session.get_score %}
             <div data-toggle="tooltip" title="{{ session.get_correct_answer_count }} out of {{ session.get_questions.count }} questions were answered correctly.">
                 <span class="font-small-2">{{ score }}%</span>
                 <progress class="progress progress-sm progress-success mb-0" value="{{ score }}" max="100"></progress>
             </div>
         {% endwith %}
         {% else %}
             <span data-toggle="tooltip" title="{{ session.get_unused_questions.count }} out of {{ session.get_questions.count }} questions remaining.">Ongoing</span>
         {% endif %}
             </td>
             <td>
               <div class="dropdown">
                 <button type="button" class="btn btn-sm btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="ft-settings"></i> Actions</button>
                 <div class="dropdown-menu">
                   {% if session.session_mode == 'SOLVED' or session.session_mode == 'INCOMPLETE' or not session.has_finished %}
                   <a class="dropdown-item" href="{% url 'exams:show_session' session.exam.category.get_slugs session.exam.pk session.pk %}"><i class="ft-play"></i> Resume</a>
                   {% else %}
                   <a class="dropdown-item" href="{% url 'exams:show_session_results' session.exam.category.get_slugs session.exam.pk session.pk %}"><i class="ft-list"></i> View results</a>
                   {% endif %}
                   <a data-pk="{{ session.pk }}" class="dropdown-item confirm-delete-session"><i class="ft-trash-2"></i> Forgive</a>
                 </div>
               </div>
             </td>
           </tr>
         {% endfor %}
         </tbody>
       </table>
    </div><!--card-block-->
  </div><!--card-body-->
</div><!--card-->

{% endblock %}
{% block customscript %}
{% with modal_id='confirm-delete-session-modal' is_small=True modal_content="<strong>Are you sure you want to forgive this session?</strong> By asking for forgiveness, you will be adjusting your performance statistics and reclaiming some 'used questions'." %}
    {% include "exams/modals/common_edit_modal.html" %}
{% endwith %}

{% with modal_id='confirm-delete-all-modal' is_small=True modal_title="Forgive me all sessions" modal_content="<strong>Are you sure you want us to forgive <em>all</em> your previous sessions?</strong> By asking for forgiveness, you will be resetting your performance statistics and reclaiming all your 'used questions'." %}
    {% include "exams/modals/common_edit_modal.html" %}
{% endwith %}
{% include 'partials/import_datatables.html' %}
<script src="{% static 'js/toastr.js' %}"></script>

    <script>
    toastr.options.positionClass = "toast-top-left";
    $(function () {
        $('[data-toggle="tooltip"]').tooltip()

        table = $(".datatable").DataTable({
            "order": [[ 1, "desc" ]]
        });

        $("#delete-all-sessions").click(function(){
          $(this).tooltip("hide");
          $("#confirm-delete-all-modal").modal('show');
        });
        $("#confirm-delete-all-modal .submit-button").click(function () {
            _paq.push(['trackEvent', 'list-previous-sessions', 'delete-all-sessions', 'delete-all-sessions']);
		        /* Send the data using post */
            $.ajax({url: "{% url 'exams:delete_session' %}",
                    data: {deletion_type: 'all'},
                    type: 'POST',
                    cahe: 'false',
                    success: function (data) {
        		            if (data.success == 1) {
        		                // show success message (using toastr)
        		                toastr.info("All your sessions have been forgiven.");
        										row = table.rows();
        										row.remove().draw(false);
                            $("#delete-all-sessions").hide();
        										$("#confirm-delete-all-modal").modal('hide');
        		            } else {
        		                toastr.error(data.message);
        		            }
        		        }
            });
				});

       $('.confirm-delete-session').tooltip({title: "<div style='direction: rtl' >Ø£Ù†Ø§ Ø£Ø®Ø·ÙŠØª Ù…Ø§ Ø£Ù†ÙƒØ±<br>ÙˆÙ„Ø§ ÙÙŠÙ‡ Ø¹Ø°Ø± ÙŠÙƒÙÙŠÙ†ÙŠ<br>Ø³ÙˆÙ‰ Ø¥Ù†ÙŠ Ø£Ø­Ø¨Ùƒ Ø­ÙŠÙ„<br>ÙˆØ¥Ù†ÙŠ Ø¯Ø§ÙŠÙ…Ø§ Ø¥Ù†Ø³Ø§Ù† ğŸ¶</div>",
                                             html: true})

        $deleteConfirmationButton = $("#confirm-delete-session-modal .submit-button")
        $('tbody').on('click','.confirm-delete-session',function () {
            $(this).tooltip("hide");
            var pk = $(this).closest('tr').data('pk');
            $deleteConfirmationButton.data('pk', pk);
            $("#confirm-delete-session-modal .modal-title").html("Forgive me for session #" + pk);
            $("#confirm-delete-session-modal").modal('show');
        });

        $deleteConfirmationButton.click(function () {
            _paq.push(['trackEvent', 'list-previous-sessions', 'delete-single-session', 'delete-single-session']);
		        /* get some values from elements on the page: */
						var pk = $(this).data('pk');
		        /* Send the data using post */
            $.ajax({url: "{% url 'exams:delete_session' %}",
                    data: {deletion_type: 'session',
                           pk: pk},
                    type: 'POST',
                    cahe: 'false',
                    success: function (data) {
        		            if (data.success == 1) {
        		                // show success message (using toastr)
        		                toastr.info("Session #" + pk + " was forgiven.");

        										row = table.row("tr[data-pk=" +  pk + "]");
        										row.remove().draw(false);
        										$("#confirm-delete-session-modal").modal('hide');
        		            } else {
        		                toastr.error(data.message);
        		            }
        		        }
            });
				});
    });
    </script>
{% endblock %}
